<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>PetCam AI Demo (H5)</title>
  <style>
    :root{
      --bg:#F7F7F9;
      --card:#fff;
      --ink:#121317;
      --muted:#6B7280;
      --brand:#FF8A5B;
      --brand2:#FFD2C2;
      --ok:#22C55E;
      --warn:#F59E0B;
      --danger:#EF4444;
      --line:#ECEEF2;
      --radius:18px;
      --shadow: 0 10px 30px rgba(18,19,23,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--ink);
    }
    .app{
      max-width:430px; margin:0 auto; min-height:100vh; position:relative;
      padding-bottom:86px;
    }
    header{
      position:sticky; top:0; z-index:5; background:linear-gradient(#fff, rgba(255,255,255,.9));
      padding:14px 16px 8px 16px; border-bottom:1px solid var(--line);
      backdrop-filter: blur(6px);
    }
    .topbar{display:flex; align-items:center; justify-content:space-between;}
    .logo{
      display:flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.3px;
    }
    .logo-dot{
      width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px var(--brand2);
    }
    .pill{
      font-size:12px;color:#fff;background:var(--ink); padding:6px 10px; border-radius:999px; display:inline-flex; gap:6px; align-items:center;
    }
    .content{padding:12px 12px 0 12px;}
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:12px; margin-bottom:12px;
    }
    .card-title{
      font-weight:700; font-size:15px; display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;
    }
    .sub{color:var(--muted); font-size:12px;}
    /* Tabs */
    .tabs{
      position:fixed; bottom:0; left:0; right:0; z-index:10;
      background:#fff; border-top:1px solid var(--line);
      padding:8px 10px calc(8px + env(safe-area-inset-bottom));
      display:flex; justify-content:space-around; gap:6px;
    }
    .tab-btn{
      flex:1; display:flex; flex-direction:column; align-items:center; gap:4px;
      padding:8px 0; border-radius:12px; color:var(--muted); font-size:12px; font-weight:600;
    }
    .tab-btn.active{ color:var(--ink); background:#FFF4F0;}
    .tab-ic{
      width:22px;height:22px;border-radius:7px;background:#F3F4F6; display:grid; place-items:center; font-size:13px;
    }
    .tab-btn.active .tab-ic{ background:var(--brand2); }

    /* Live / dashboard */
    .live-wrap{display:grid; grid-template-columns:1fr; gap:10px;}
    .live-hero{
      position:relative; border-radius:16px; overflow:hidden; height:220px; background:#111;
      display:flex; align-items:center; justify-content:center; color:#fff;
    }
    .live-hero video{width:100%; height:100%; object-fit:cover; filter:saturate(1.05) contrast(1.05);}
    .live-overlay{
      position:absolute; inset:0; background:
        linear-gradient(180deg, rgba(0,0,0,.35), transparent 35%),
        linear-gradient(0deg, rgba(0,0,0,.45), transparent 45%);
      pointer-events:none;
    }
    .track-box{
      position:absolute; border:2px solid rgba(255,255,255,.9); border-radius:10px;
      width:120px; height:90px; left:40%; top:35%; transform:translate(-50%,-50%);
      box-shadow:0 0 0 2px rgba(255,138,91,.35) inset;
      transition:all .7s ease;
    }
    .track-label{
      position:absolute; left:8px; top:8px; font-size:12px; font-weight:700; background:rgba(0,0,0,.6);
      padding:4px 6px; border-radius:8px;
    }
    .cam-switch{
      position:absolute; right:8px; top:8px; display:flex; gap:6px;
    }
    .cam-btn{
      font-size:11px; font-weight:700; color:#fff; background:rgba(0,0,0,.55);
      padding:6px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
      cursor:pointer; user-select:none;
    }
    .cam-btn.active{ background:rgba(255,138,91,.9); border-color:transparent; }

    .live-status{
      position:absolute; left:8px; bottom:8px; display:flex; gap:8px; align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--ok); box-shadow:0 0 10px rgba(34,197,94,.9);}
    .status-pill{
      background:rgba(0,0,0,.6); padding:6px 8px; border-radius:999px; font-size:12px; font-weight:700;
      display:flex; gap:6px; align-items:center;
    }
    .behavior-chip{
      position:absolute; left:50%; bottom:50px; transform:translateX(-50%);
      background:rgba(255,255,255,.95); color:#111; padding:8px 12px; border-radius:999px;
      display:flex; gap:6px; align-items:center; font-size:13px; font-weight:800;
      box-shadow:0 8px 16px rgba(0,0,0,.2);
      transition:all .4s ease; white-space:nowrap;
    }
    .behavior-chip .b-dot{width:7px;height:7px;border-radius:50%;}
    .behavior-chip.ok .b-dot{background:var(--ok)}
    .behavior-chip.warn .b-dot{background:var(--warn)}
    .behavior-chip.danger .b-dot{background:var(--danger)}

    .live-actions{display:flex; gap:8px; margin-top:8px;}
    .btn{
      flex:1; padding:10px 0; border-radius:12px; background:#111; color:#fff; font-weight:800; font-size:13px;
      display:grid; place-items:center; cursor:pointer; user-select:none;
    }
    .btn.ghost{background:#FFF4F0;color:#111;border:1px solid #FFD7C8}
    .mini-row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .metric{display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .metric .big{font-size:20px;font-weight:900;}
    .metric .tag{font-size:11px;color:var(--muted);font-weight:700;}
    .metric .trend{font-size:12px;font-weight:800;color:var(--ok);}
    .metric .trend.warn{color:var(--warn);}

    .pet-strip{display:flex; gap:8px; overflow:auto; padding-bottom:2px;}
    .pet-chip{
      min-width:84px; border:1px solid var(--line); border-radius:14px; padding:8px; display:flex; gap:8px; align-items:center;
      cursor:pointer; background:#fff;
    }
    .pet-chip.active{ border-color:#FFB59B; background:#FFF4F0; }
    .pet-avatar{
      width:34px;height:34px;border-radius:12px;background:#F3F4F6; display:grid; place-items:center; font-weight:900;
    }
    .pet-meta{display:flex; flex-direction:column; line-height:1.1;}
    .pet-name{font-weight:900; font-size:13px;}
    .pet-state{font-size:11px; color:var(--muted); font-weight:700;}

    /* Location */
    .floorplan{
      position:relative; height:260px; border-radius:16px; background:#FAFAFB; border:1px dashed #E5E7EB; overflow:hidden;
      display:grid; place-items:center;
    }
    .room{
      position:absolute; border:1.5px solid #E5E7EB; border-radius:12px; background:#fff;
      display:grid; place-items:center; font-size:12px; font-weight:800; color:#444;
    }
    .fp-living{left:12px; top:12px; width:58%; height:56%;}
    .fp-bed{right:12px; top:12px; width:36%; height:38%;}
    .fp-dining{left:12px; bottom:12px; width:40%; height:34%;}
    .fp-litter{right:12px; bottom:12px; width:52%; height:46%;}
    .pet-dot{
      position:absolute; width:14px;height:14px;border-radius:50%; background:var(--brand);
      transform:translate(-50%,-50%); box-shadow:0 8px 18px rgba(255,138,91,.7);
      transition:all .6s ease;
    }
    .trail{
      position:absolute; width:6px;height:6px;border-radius:50%; background:#FFB59B; opacity:.7;
      transform:translate(-50%,-50%); transition:all .6s ease;
    }
    .timebar{display:flex; align-items:center; gap:8px;}
    input[type="range"]{width:100%;}
    .legend{display:flex; gap:8px; flex-wrap:wrap;}
    .legend .chip{font-size:11px;font-weight:800;color:#111;background:#FFF4F0;border:1px solid #FFD7C8;padding:5px 8px;border-radius:999px;}

    /* Feed */
    .feed-item{
      display:flex; gap:10px; padding:10px 6px; border-bottom:1px dashed var(--line);
    }
    .feed-item:last-child{border-bottom:none;}
    .feed-ic{
      width:40px;height:40px;border-radius:12px;background:#FFF4F0; display:grid; place-items:center; font-size:18px;
      flex:0 0 auto;
    }
    .feed-body{flex:1;}
    .feed-title{font-weight:900; font-size:14px;}
    .feed-meta{font-size:12px;color:var(--muted);font-weight:700;margin-top:3px;}
    .feed-actions{margin-top:6px; display:flex; gap:6px;}
    .feed-btn{
      font-size:12px; font-weight:800; background:#111; color:#fff; padding:6px 8px; border-radius:10px; cursor:pointer;
    }
    .feed-btn.ghost{background:#F3F4F6;color:#111;}

    /* Alerts modal */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100; display:none; align-items:flex-end;
    }
    .modal.show{display:flex;}
    .sheet{
      width:100%; max-width:430px; margin:0 auto; background:#fff; border-radius:18px 18px 0 0; padding:12px; max-height:85vh; overflow:auto;
      box-shadow:var(--shadow);
      animation:up .18s ease;
    }
    @keyframes up{from{transform:translateY(20px);opacity:.6} to{transform:none;opacity:1}}
    .alert-card{
      border:1px solid var(--line); border-radius:14px; padding:10px; display:flex; gap:10px; margin-bottom:8px;
    }
    .alert-level{
      font-size:11px; font-weight:900; padding:3px 6px; border-radius:999px; color:#fff; height:fit-content;
    }
    .lvl-danger{background:var(--danger)}
    .lvl-warn{background:var(--warn)}
    .lvl-info{background:#111}
    .alert-title{font-weight:900; font-size:14px;}
    .alert-desc{font-size:12px;color:var(--muted);font-weight:700;margin-top:2px;}
    .alert-actions{margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;}
    .small-btn{
      font-size:12px; font-weight:900; padding:6px 8px; border-radius:10px; cursor:pointer;
      background:#111;color:#fff;
    }
    .small-btn.ghost{background:#F3F4F6;color:#111;}

    /* Simple switches */
    .row{display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px dashed var(--line);}
    .row:last-child{border-bottom:none;}
    .switch{
      width:44px;height:26px;border-radius:999px;background:#E5E7EB; position:relative; cursor:pointer;
    }
    .switch::after{
      content:""; position:absolute; top:3px; left:3px; width:20px;height:20px;border-radius:50%; background:#fff; transition:all .2s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .switch.on{background:#FFD2C2;}
    .switch.on::after{left:21px; background:var(--brand);}

    .hidden{display:none;}
    .section-title{font-weight:900; font-size:16px; margin:2px 0 8px;}
    .tagline{font-size:12px; color:var(--muted); font-weight:700;}
  </style>
</head>
<body>
<div class="app" id="app">

  <header>
    <div class="topbar">
      <div class="logo">
        <div class="logo-dot"></div>
        <div>PetCam AI</div>
        <span class="sub">H5 Demo</span>
      </div>
      <div class="pill" id="headerPill">å®¢å…æ‘„åƒå¤´ Â· è¿½è¸ªä¸­</div>
    </div>
  </header>

  <main class="content">

    <!-- TAB 1: çœ‹æŠ¤ -->
    <section id="tab-watch">

      <div class="card">
        <div class="card-title">
          <span>å®æ—¶çœ‹æŠ¤</span>
          <span class="sub" id="liveTime">ä»Šå¤© 15:00</span>
        </div>

        <div class="live-wrap">
          <div class="live-hero">
            <video id="liveVideo" autoplay muted loop playsinline>
              <source src="./living_cat2.mp4" type="video/mp4">
            </video>
            <div class="live-overlay"></div>

            <div class="cam-switch">
              <div class="cam-btn active" data-cam="living">å®¢å…</div>
              <div class="cam-btn" data-cam="bed">å§å®¤</div>
            </div>

            <div class="track-box" id="trackBox">
              <div class="track-label" id="trackLabel">è¿½è¸ªï¼šç±³è¯º</div>
            </div>

            <div class="behavior-chip ok" id="behaviorChip">
              <div class="b-dot"></div>
              <div id="behaviorText">æ­£åœ¨å·¡è§†å®¢å…</div>
            </div>

            <!-- LLM é£æ ¼å®æ—¶è§£è¯»æ°”æ³¡ -->
            <div style="
              position:absolute; left:50%; bottom:12px; transform:translateX(-50%);
              width:92%; background:rgba(0,0,0,.55); color:#fff; padding:10px 12px;
              border-radius:14px; font-size:13px; line-height:1.45; font-weight:650;
              box-shadow:0 8px 16px rgba(0,0,0,.25); backdrop-filter: blur(4px);
            " id="aiNarration">
              AI è§£è¯»åŠ è½½ä¸­â€¦
            </div>

            <div class="live-status">
              <div class="status-pill"><span class="dot"></span><span id="trackStatus">è¿½è¸ªä¸­</span></div>
              <div class="status-pill" id="signalPill">ä¿¡å·è‰¯å¥½</div>
            </div>
          </div>

          <div class="live-actions">
            <div class="btn ghost" id="btnReplay">å›æ”¾10ç§’</div>
            <div class="btn" id="btnCall">å‘¼å«å® ç‰©</div>
            <div class="btn ghost" id="btnSnap">æˆªå›¾</div>
          </div>

          <div class="mini-row">
            <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:0;">
              <div class="metric">
                <div>
                  <div class="tag">ä»Šæ—¥æ´»åŠ¨</div>
                  <div class="big" id="mActivity">72</div>
                </div>
                <div class="trend" id="mActivityTrend">+12%</div>
              </div>
            </div>
            <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:0;">
              <div class="metric">
                <div>
                  <div class="tag">ç¡çœ æ—¶é•¿</div>
                  <div class="big" id="mSleep">9.3h</div>
                </div>
                <div class="trend warn" id="mSleepTrend">åå°‘</div>
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <!-- ä»Šæ—¥å°ç»“å¡ç‰‡ -->
          <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:0;">
            <div class="card-title" style="margin-bottom:6px;">
              <span>ä»Šæ—¥å°ç»“</span>
              <span class="sub" id="summaryTime">å®æ—¶ç”Ÿæˆ</span>
            </div>
            <div id="dailySummary" style="font-size:13px;line-height:1.55;font-weight:700;color:#111;">
              å°ç»“ç”Ÿæˆä¸­â€¦
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <div class="btn ghost" id="btnRefreshSummary" style="flex:1;">åˆ·æ–°å°ç»“</div>
              <div class="btn ghost" id="btnShareSummary" style="flex:1;">åˆ†äº«å¡ç‰‡ï¼ˆdemoï¼‰</div>
            </div>
          </div>

        </div>

        <div style="height:10px"></div>
        <div class="card-title" style="margin-bottom:6px;">
          <span>å¤šå® è¿½è¸ª</span>
          <span class="sub">è‡ªåŠ¨è¯†åˆ«å® ç‰©å¹¶åˆ‡æ¢è¿½è¸ªæ¡†</span>
        </div>
        <div class="pet-strip" id="petStrip"></div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>ä»Šæ—¥å¼‚å¸¸å¿«è§ˆ</span>
          <span class="sub" id="alertCount">2 æ¡æ–°å‘Šè­¦</span>
        </div>
        <div id="alertPreview"></div>
        <div class="btn ghost" id="openAlerts">æŸ¥çœ‹å…¨éƒ¨å‘Šè­¦</div>
      </div>

    </section>

    <!-- TAB 2: ä½ç½® -->
    <section id="tab-location" class="hidden">

      <div class="card">
        <div class="card-title">
          <span>å®¶åº­å®šä½</span>
          <span class="sub" id="locPetName">ç±³è¯º Â· ç°åœ¨åœ¨å®¢å…</span>
        </div>

        <div class="floorplan" id="floorplan">
          <div class="room fp-living">å®¢å…</div>
          <div class="room fp-bed">å§å®¤</div>
          <div class="room fp-dining">é¤åŒº</div>
          <div class="room fp-litter">çŒ«ç ‚åŒº</div>

          <div class="pet-dot" id="petDot"></div>
          <div id="trailLayer"></div>
        </div>

        <div style="height:10px"></div>
        <div class="timebar">
          <span class="sub" id="timeLabel">08:00</span>
          <input id="timeSlider" type="range" min="0" max="24" value="8" step="1">
          <span class="sub">24:00</span>
        </div>
        <div class="sub" style="margin-top:6px;">
          æ‹–åŠ¨æ—¶é—´è½´æŸ¥çœ‹å¯¹åº”ä½ç½®ï¼ˆè§†è§‰è¿½è¸ªå®šä½ï¼‰
        </div>

        <div style="height:10px"></div>
        <div class="legend">
          <div class="chip" id="stayStats">å§å®¤ 45% Â· å®¢å… 30% Â· é¤åŒº 15% Â· çŒ«ç ‚åŒº 10%</div>
          <div class="chip">å®šä½ç²¾åº¦ï¼šçº¦ 1â€“2mï¼ˆå…‰ç…§/é®æŒ¡å½±å“ï¼‰</div>
        </div>

      </div>

      <div class="card">
        <div class="card-title">
          <span>å¤šæ‘„åƒå¤´è¦†ç›–</span>
          <span class="sub" id="camCoverage">å½“å‰ï¼šå®¢å…æ‘„åƒå¤´ä¼˜å…ˆ</span>
        </div>
        <div style="display:flex; gap:8px;">
          <div class="btn ghost camPick active" data-cam="living">å®¢å…è§†è§’</div>
          <div class="btn ghost camPick" data-cam="bed">å§å®¤è§†è§’</div>
        </div>
      </div>

    </section>

    <!-- TAB 3: äº‹ä»¶ -->
    <section id="tab-feed" class="hidden">

      <div class="card">
        <div class="card-title">
          <span>ä»Šæ—¥äº‹ä»¶æ—¶é—´çº¿</span>
          <span class="sub">è‡ªåŠ¨ç”Ÿæˆè¡Œä¸ºæ‘˜è¦ï¼Œå¯ä¸€é”®å›æ”¾</span>
        </div>

        <div style="display:flex; gap:6px; margin-bottom:8px;">
          <div class="pill" style="background:#FFF4F0;color:#111;border:1px solid #FFD7C8;" data-filter="all">å…¨éƒ¨</div>
          <div class="pill" style="background:#fff;color:#111;border:1px solid var(--line);" data-filter="normal">åƒå–/å¦‚å•</div>
          <div class="pill" style="background:#fff;color:#111;border:1px solid var(--line);" data-filter="motion">è¿åŠ¨/è¿½é€</div>
          <div class="pill" style="background:#fff;color:#111;border:1px solid var(--line);" data-filter="abnormal">å¼‚å¸¸</div>
        </div>

        <div id="feedList"></div>
      </div>

    </section>

    <!-- TAB 4: æˆ‘çš„ -->
    <section id="tab-me" class="hidden">

      <div class="card">
        <div class="section-title">å® ç‰©æ¡£æ¡ˆ</div>
        <div id="petProfiles"></div>
        <div class="btn ghost" style="margin-top:8px;">+ æ·»åŠ æ–°å® ç‰©ï¼ˆdemoï¼‰</div>
      </div>

      <div class="card">
        <div class="section-title">è®¾å¤‡è®¾ç½®</div>

        <div class="row">
          <div>
            <div style="font-weight:900;">è‡ªåŠ¨è¿½è¸ªä¼˜å…ˆ</div>
            <div class="tagline">æ‘„åƒå¤´è‡ªåŠ¨è·Ÿæ‹å¹¶èšç„¦å® ç‰©</div>
          </div>
          <div class="switch on" data-switch="track"></div>
        </div>

        <div class="row">
          <div>
            <div style="font-weight:900;">å¼‚å¸¸æé†’</div>
            <div class="tagline">æ‰“æ¶/å‘•å/é•¿æ—¶é—´ä¸åŠ¨ç­‰</div>
          </div>
          <div class="switch on" data-switch="alert"></div>
        </div>

        <div class="row">
          <div>
            <div style="font-weight:900;">å¤œè§†å¢å¼º</div>
            <div class="tagline">ä½å…‰ç¯å¢ƒè¯†åˆ«æ•ˆæœæ›´å¥½</div>
          </div>
          <div class="switch" data-switch="night"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">å…³äºæœ¬ Demo</div>
        <div class="tagline">
          è¿™æ˜¯ H5 åŸå‹ï¼Œä»…æ¨¡æ‹Ÿï¼šç›´æ’­è¿½è¸ªã€è¡Œä¸ºè¯†åˆ«ã€å®šä½è½¨è¿¹ã€äº‹ä»¶/å‘Šè­¦ã€ä»Šæ—¥å°ç»“ã€‚<br/>
          åç»­å¯æ›¿æ¢çœŸå®æ‘„åƒå¤´æµä¸æ¨¡å‹ç»“æœã€‚
        </div>
      </div>

    </section>

  </main>

  <!-- bottom tabs -->
  <nav class="tabs">
    <div class="tab-btn active" data-tab="watch">
      <div class="tab-ic">ğŸ¥</div><div>çœ‹æŠ¤</div>
    </div>
    <div class="tab-btn" data-tab="location">
      <div class="tab-ic">ğŸ—ºï¸</div><div>ä½ç½®</div>
    </div>
    <div class="tab-btn" data-tab="feed">
      <div class="tab-ic">ğŸ“Œ</div><div>äº‹ä»¶</div>
    </div>
    <div class="tab-btn" data-tab="me">
      <div class="tab-ic">ğŸ‘¤</div><div>æˆ‘çš„</div>
    </div>
  </nav>

</div>

<!-- Alerts modal -->
<div class="modal" id="alertsModal">
  <div class="sheet">
    <div class="card-title" style="margin-bottom:6px;">
      <span>å¼‚å¸¸å‘Šè­¦ä¸­å¿ƒ</span>
      <div class="btn ghost" id="closeAlerts" style="flex:0 0 auto; padding:6px 10px; font-size:12px;">å…³é—­</div>
    </div>
    <div class="sub" style="margin-bottom:10px;">ç‚¹å‡»å‘Šè­¦æŸ¥çœ‹ 20 ç§’è¯æ®ç‰‡æ®µï¼Œå¹¶å¯æ ‡è®°è¯¯æŠ¥</div>
    <div id="alertsList"></div>
  </div>
</div>

<script>
/* -----------------------------
   Pace controls (ä½ æƒ³æ›´æ…¢å°±è°ƒè¿™é‡Œ)
----------------------------- */
const BEHAVIOR_INTERVAL_MS = 9000;   // è¡Œä¸º/è¿½è¸ªåˆ‡æ¢é—´éš”ï¼ˆåŸæ¥ 4200ï¼‰
const SUMMARY_REFRESH_MS  = 30000;  // ä»Šæ—¥å°ç»“è‡ªåŠ¨åˆ·æ–°æœ€å°é—´éš”ï¼ˆåŸæ¥æ¯æ¬¡è¡Œä¸ºéƒ½åˆ·ï¼‰
let lastSummaryTs = 0;

/* -----------------------------
   Demo data
----------------------------- */
const pets = [
  { id:"mino", name:"ç±³è¯º", emoji:"ğŸ±", color:"#FF8A5B" },
  { id:"coco", name:"å¯å¯", emoji:"ğŸ±", color:"#F59E0B" }
];

const cams = {
  living: { name:"å®¢å…æ‘„åƒå¤´", video:"./living_cat2.mp4" },
  bed:    { name:"å§å®¤æ‘„åƒå¤´", video:"./living_cat2.mp4" }
};

const behaviors = {
  mino: [
    { text:"æ­£åœ¨å·¡è§†å®¢å…", level:"ok", room:"å®¢å…", pos:[32,38], action:"patrol" },
    { text:"åœ¨é¤åŒºé—»é£Ÿç›†", level:"ok", room:"é¤åŒº", pos:[25,78], action:"sniff_food" },
    { text:"å¿«é€Ÿå¥”è·‘ï¼ˆç–‘ä¼¼è¿½é€ï¼‰", level:"warn", room:"å®¢å…", pos:[44,46], action:"chase" },
    { text:"è¿›å…¥çŒ«ç ‚ç›†ï¼ˆå¦‚å•ï¼‰", level:"ok", room:"çŒ«ç ‚åŒº", pos:[76,74], action:"litter" },
    { text:"ç–‘ä¼¼å‘•åï¼ˆå·²å½•åˆ¶ç‰‡æ®µï¼‰", level:"danger", room:"å®¢å…", pos:[36,52], abnormal:"vomit", action:"vomit" },
    { text:"è¶´å§ä¼‘æ¯", level:"ok", room:"å§å®¤", pos:[78,26], action:"rest" },
    { text:"ä¸å¦ä¸€åªçŒ«å¯¹å³™ï¼ˆç–‘ä¼¼æ‰“æ¶ï¼‰", level:"danger", room:"å®¢å…", pos:[50,44], abnormal:"fight", action:"fight" },
    { text:"åœ¨å§å®¤æ‰“ç›¹", level:"ok", room:"å§å®¤", pos:[80,22], action:"sleep" },
    { text:"é•¿æ—¶é—´ä¸åŠ¨ï¼ˆéœ€ç•™æ„ï¼‰", level:"warn", room:"å§å®¤", pos:[82,18], abnormal:"still", action:"still" },
  ],
  coco: [
    { text:"åœ¨å®¢å…ç©é€—çŒ«æ£’", level:"ok", room:"å®¢å…", pos:[55,48], action:"play" },
    { text:"åœ¨å§å®¤æ™’å¤ªé˜³", level:"ok", room:"å§å®¤", pos:[72,22], action:"sunbathe" },
    { text:"è¿½é€ç±³è¯º", level:"warn", room:"å®¢å…", pos:[48,40], action:"chase" },
    { text:"åœ¨çŒ«ç ‚åŒºåœç•™", level:"ok", room:"çŒ«ç ‚åŒº", pos:[70,80], action:"litter" },
    { text:"åœ¨é¤åŒºå–æ°´", level:"ok", room:"é¤åŒº", pos:[34,82], action:"drink" },
  ]
};

const feedItems = [
  { t:"08:12", pet:"mino", type:"normal", icon:"ğŸš½", title:"åœ¨çŒ«ç ‚ç›†ï¼ˆ2minï¼‰", desc:"è¯†åˆ«åˆ°å¦‚å•è¡Œä¸ºï¼Œåœç•™ 2 åˆ†é’Ÿ", clip:true },
  { t:"09:40", pet:"mino", type:"motion", icon:"ğŸƒ", title:"å¿«é€Ÿå¥”è·‘ï¼ˆç–‘ä¼¼è¿½é€ï¼‰", desc:"æ´»åŠ¨å³°å€¼æŒç»­ 35 ç§’", clip:true },
  { t:"11:05", pet:"mino", type:"abnormal", icon:"ğŸ¤¢", title:"å‘•åå¼‚å¸¸", desc:"ç–‘ä¼¼æ¯›çƒå‘•åï¼ŒæŒç»­çº¦ 8 ç§’", clip:true, level:"danger" },
  { t:"13:22", pet:"coco", type:"normal", icon:"ğŸ’§", title:"å–æ°´ï¼ˆ1minï¼‰", desc:"é¤åŒºé¥®æ°´ 1 åˆ†é’Ÿ", clip:false },
  { t:"14:10", pet:"mino", type:"abnormal", icon:"âš¡", title:"ç–‘ä¼¼æ‰“æ¶", desc:"ä¸å¯å¯å‡ºç°å¯¹å³™è¿½é€", clip:true, level:"danger" },
  { t:"14:50", pet:"mino", type:"abnormal", icon:"ğŸ›‘", title:"é•¿æ—¶é—´ä¸åŠ¨", desc:"å§å®¤é™æ­¢ 1.5 å°æ—¶ï¼Œå»ºè®®å…³æ³¨", clip:true, level:"warn" },
];

let alerts = [
  { id:"a1", pet:"mino", time:"11:05", type:"vomit", title:"ç–‘ä¼¼å‘•å", level:"danger", desc:"æ£€æµ‹åˆ°è¿ç»­è…¹éƒ¨æ”¶ç¼©+æ¶²ä½“å–·æº…åŠ¨ä½œ" },
  { id:"a2", pet:"mino", time:"14:10", type:"fight", level:"danger", title:"ç–‘ä¼¼æ‰“æ¶", desc:"æ£€æµ‹åˆ°é«˜å¼ºåº¦è¿½é€+å°–å«å£°å³°å€¼" },
  { id:"a3", pet:"mino", time:"14:50", type:"still", level:"warn", title:"é•¿æ—¶é—´ä¸åŠ¨", desc:"é™æ­¢è¶…è¿‡ 90 åˆ†é’Ÿ" },
];

/* -----------------------------
   State
----------------------------- */
let activeTab = "watch";
let activePet = pets[0].id;
let activeCam = "living";
let behaviorIdx = 0;
let trail = [];
let recentContext = [];

// ä»Šæ—¥ç»Ÿè®¡ï¼ˆæ¯åªå® ç‰©ç‹¬ç«‹ï¼‰
let dailyStats = {
  mino: initDailyStats(),
  coco: initDailyStats()
};

function initDailyStats(){
  return {
    rooms: new Set(),
    actions: {},
    abnormal: 0,
    motionBursts: 0,
    litter: 0,
    drinkEat: 0,
    restSleep: 0,
    lastAbnormal: null,
    lastAction: null,
    startTs: Date.now()
  };
}

/* -----------------------------
   Helpers
----------------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const rnd = arr => arr[Math.floor(Math.random()*arr.length)];

/* -----------------------------
   LLM-style narration engine
----------------------------- */
const llmTemplates = {
  openers: [
    "æˆ‘è¿™è¾¹çœ‹åˆ°ï¼Œ",
    "ç°åœ¨ç”»é¢é‡Œï¼Œ",
    "ä»è¿½è¸ªç»“æœæ¥çœ‹ï¼Œ",
    "ç»“åˆåˆšæ‰çš„è¡Œä¸ºè½¨è¿¹ï¼Œ",
    "åˆæ­¥åˆ¤æ–­æ˜¯ï¼š",
  ],
  hedges: [
    "å¤§æ¦‚ç‡",
    "çœ‹èµ·æ¥åƒæ˜¯",
    "æ¯”è¾ƒå¯èƒ½æ˜¯",
    "å€¾å‘äºè®¤ä¸ºæ˜¯",
    "ä¸æ’é™¤æ˜¯",
  ],
  normalInsights: {
    patrol: [
      "åœ¨{room}èŒƒå›´å†…æ¥å›å·¡è§†ï¼ŒèŠ‚å¥æ¯”è¾ƒæ”¾æ¾ã€‚",
      "æ´»åŠ¨çŠ¶æ€æ­£å¸¸ï¼Œåƒæ˜¯åœ¨ç†Ÿæ‚‰ç¯å¢ƒæˆ–æ‰¾ç©å…·ã€‚",
    ],
    sniff_food: [
      "å›´ç€é£Ÿç›†æ¢æŸ¥æ°”å‘³ï¼Œæš‚æ—¶æ²¡æœ‰æ˜æ˜¾è¿›é£ŸåŠ¨ä½œã€‚",
      "åƒæ˜¯åœ¨ç¡®è®¤æœ‰æ²¡æœ‰æ–°é£Ÿç‰©æˆ–é›¶é£Ÿã€‚",
    ],
    play: [
      "å…´å¥‹åº¦ä¸Šå‡ï¼ŒåŠ¨ä½œè½»å¿«ï¼Œå±äºæ­£å¸¸ç©è€ã€‚",
      "çœ‹èµ·æ¥å¿ƒæƒ…ä¸é”™ï¼Œæ¢ç´¢æ¬²æ¯”è¾ƒå¼ºã€‚",
    ],
    sleep: [
      "è¿›å…¥æµ…ç¡/æ‰“ç›¹é˜¶æ®µï¼Œå‘¼å¸å’Œä½“æ€éƒ½å¾ˆå¹³ç¨³ã€‚",
      "ç¡å§¿æ”¾æ¾ï¼Œå±äºå®‰å¿ƒä¼‘æ¯ã€‚",
    ],
    rest: [
      "è¶´å§ä¼‘æ¯ä¸­ï¼ŒçŠ¶æ€å¹³ç¨³ã€‚",
      "çŸ­æ—¶ä¼‘æ•´ï¼Œå¯èƒ½ç©ç´¯äº†ã€‚",
    ],
    sunbathe: [
      "åœ¨{room}æ™’å¤ªé˜³ï¼Œåœç•™æ—¶é—´åé•¿ä½†å±äºå¸¸è§è¡Œä¸ºã€‚",
      "æ”¾æ¾å–æš–ä¸­ï¼Œçœ‹èµ·æ¥å¾ˆèˆ’é€‚ã€‚",
    ],
    litter: [
      "å¦‚å•è¡Œä¸ºå®Œæˆå¾—æ¯”è¾ƒé¡ºç•…ï¼Œåœç•™æ—¶é•¿æ­£å¸¸ã€‚",
      "æœ¬æ¬¡çŒ«ç ‚ç›†åœç•™å±äºå¸¸è§„èŠ‚å¥ã€‚",
    ],
    drink: [
      "åœ¨{room}è¡¥æ°´ï¼ŒæŒç»­æ—¶é—´æ­£å¸¸ã€‚",
      "é¥®æ°´é¢‘ç‡ç¬¦åˆæ—¥å¸¸æ°´å¹³ã€‚",
    ],
    chase: [
      "å‡ºç°çŸ­æ—¶é«˜é€Ÿè¿½é€/å¥”è·‘ï¼Œå¼ºåº¦ç•¥é«˜ã€‚",
      "å¯èƒ½æ˜¯åœ¨è‡ªå—¨è·‘é…·ï¼Œä¹Ÿå¯èƒ½å’Œå¦ä¸€åªçŒ«äº’åŠ¨ã€‚",
    ]
  },
  abnormalInsights: {
    vomit: [
      "æ£€æµ‹åˆ°è¿ç»­è…¹éƒ¨æ”¶ç¼©ä¸å¤´éƒ¨å‰ä¼¸ï¼Œ{hedge}æ˜¯åæ¯›çƒæˆ–è½»åº¦å‘•åã€‚",
      "ç—‡çŠ¶æŒç»­æ—¶é—´ä¸é•¿ï¼Œä½†å»ºè®®ä»Šå¤©ç•™æ„é¥®é£Ÿä¸ç²¾ç¥çŠ¶æ€ã€‚",
    ],
    fight: [
      "ä¸¤åªçŒ«çš„è·ç¦»å¿«é€Ÿæ‹‰è¿‘+å¯¹å³™å§¿æ€æ˜æ˜¾ï¼Œ{hedge}å‘ç”Ÿäº†å†²çªã€‚",
      "å¦‚æœä½ å®¶æœ‰åŸä½æ°‘/æ–°çŒ«ç£¨åˆæœŸï¼Œå»ºè®®å…³æ³¨æ˜¯å¦å½¢æˆæŒç»­å‹åŠ›ã€‚",
    ],
    still: [
      "é™æ­¢æ—¶é—´å·²è¶…è¿‡é˜ˆå€¼ï¼Œ{hedge}æ˜¯ä¼‘æ¯è¿‡ä¹…æˆ–æƒ…ç»ªä½è½ã€‚",
      "å¦‚æœåŒæ—¶ä¼´éšé£Ÿæ¬²ä¸‹é™/èº²è—å¢å¤šï¼Œå†è€ƒè™‘å°±åŒ»è¯„ä¼°ã€‚",
    ]
  },
  endings: [
    "ä½ å¯ä»¥å…ˆä¸ç”¨å¤ªç„¦è™‘ï¼Œæˆ‘ä¼šç»§ç»­ç›¯ç€ã€‚",
    "å¦‚æœæƒ³ï¼Œæˆ‘ä¹Ÿå¯ä»¥æŠŠè¿™æ®µè‡ªåŠ¨å‰ªæˆé«˜å…‰ç»™ä½ å›çœ‹ã€‚",
    "éœ€è¦æˆ‘æŠŠæœ€è¿‘ 1 å°æ—¶çš„è¡Œä¸ºåšä¸ªå°ç»“å—ï¼Ÿ",
    "æˆ‘ä¼šç»§ç»­è§‚å¯Ÿæ˜¯å¦å‡ºç°é‡å¤å¼‚å¸¸ã€‚",
  ]
};

function llmNarrate(b){
  const petName = pets.find(p=>p.id===activePet)?.name || "å®ƒ";
  const opener = rnd(llmTemplates.openers);
  const hedge = rnd(llmTemplates.hedges);

  let body = "";
  if(b.abnormal){
    const arr = llmTemplates.abnormalInsights[b.action] || llmTemplates.abnormalInsights[b.abnormal] || [];
    body = arr.map(s=>s.replace("{hedge}", hedge).replace("{room}", b.room)).join(" ");
  }else{
    const arr = llmTemplates.normalInsights[b.action] || [];
    body = rnd(arr).replace("{room}", b.room);
  }

  let contextLine = "";
  const last = recentContext[recentContext.length-1];
  if(last && last.room !== b.room){
    contextLine = `å®ƒåˆšåˆšä»${last.room}ç§»åŠ¨åˆ°${b.room}ï¼ŒåŠ¨çº¿æ¯”è¾ƒè¿è´¯ã€‚`;
  }else if(last && last.action === b.action){
    contextLine = `è¿™ä¸ªè¡Œä¸ºæ¨¡å¼æŒç»­äº†ä¸€å°æ®µæ—¶é—´ï¼Œå±äºç¨³å®šçŠ¶æ€ã€‚`;
  }

  const ending = rnd(llmTemplates.endings);
  return `${opener}${petName}${body} ${contextLine} ${ending}`.trim();
}

// ä»Šæ—¥å°ç»“æ¨¡æ¿
const dailySummaryTemplates = {
  openers: [
    "ä»Šå¤©åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ{pet}æ•´ä½“çŠ¶æ€æˆ‘è§‰å¾—æŒºä¸é”™çš„ã€‚",
    "æˆ‘æŠŠ{pet}ä»Šå¤©çš„è¡Œä¸ºç®€å•æ‹¼äº†ä¸€ä¸‹ï¼š",
    "æˆªæ­¢ç°åœ¨ï¼Œ{pet}ä»Šå¤©çš„ç”Ÿæ´»èŠ‚å¥å¤§æ¦‚æ˜¯è¿™æ ·â€”â€”",
    "å…ˆç»™ä½ ä¸€ä¸ªç®€çŸ­ä½†æœ‰ä¿¡æ¯é‡çš„å°ç»“ï¼š"
  ],
  energy: [
    "æ´»è·ƒåº¦åé«˜ï¼Œåƒæ˜¯ç²¾åŠ›å¾ˆè¶³ã€‚",
    "æ´»è·ƒåº¦ä¸­ç­‰ï¼ŒèŠ‚å¥æ¯”è¾ƒå¥åº·ã€‚",
    "æ•´ä½“æ¯”è¾ƒå®‰é™ï¼Œå¯èƒ½åœ¨ä¼‘æ¯å›è¡€ã€‚"
  ],
  risk: [
    "æš‚æ—¶æ²¡çœ‹åˆ°æ˜æ˜¾å¼‚å¸¸ï¼Œä½ å¯ä»¥æ¯”è¾ƒæ”¾å¿ƒã€‚",
    "æœ‰{n}æ¬¡å¼‚å¸¸ä¿¡å·ï¼Œä½†éƒ½å±äºå¯è§‚å¯ŸèŒƒå›´ã€‚",
    "å¼‚å¸¸ä¿¡å·åå¤šï¼ˆ{n}æ¬¡ï¼‰ï¼Œå»ºè®®ä»Šå¤©å¤šç•™æ„ã€‚"
  ],
  endings: [
    "å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æ™šä¸Šå†ç»™ä½ ä¸€ç‰ˆæ—¥ç»ˆæ€»ç»“ã€‚",
    "ä½ æƒ³æˆ‘æŠŠå¼‚å¸¸ç‰‡æ®µæ‰“åŒ…æˆä¸€ä¸ªå›æ”¾åˆé›†å—ï¼Ÿ",
    "æˆ‘ä¼šç»§ç»­ç›¯ç€ï¼Œæœ‰æƒ…å†µç¬¬ä¸€æ—¶é—´æ¨ç»™ä½ ã€‚"
  ]
};

function updateDailyStats(b){
  const s = dailyStats[activePet] || (dailyStats[activePet]=initDailyStats());
  s.rooms.add(b.room);
  s.actions[b.action] = (s.actions[b.action]||0) + 1;
  s.lastAction = b.action;

  if(["chase","play"].includes(b.action)) s.motionBursts++;
  if(b.action==="litter") s.litter++;
  if(["drink","sniff_food"].includes(b.action)) s.drinkEat++;
  if(["rest","sleep","sunbathe"].includes(b.action)) s.restSleep++;

  if(b.abnormal){
    s.abnormal++;
    s.lastAbnormal = b.abnormal;
  }
}

function llmDailySummary(petId){
  const petName = pets.find(p=>p.id===petId)?.name || "å®ƒ";
  const s = dailyStats[petId] || initDailyStats();

  const rooms = Array.from(s.rooms);
  const roomText = rooms.length ? rooms.join("ã€") : "ä¸»è¦æ´»åŠ¨åœ¨å®¶ä¸­";

  const energyIdx =
    s.motionBursts >= 3 ? 0 :
    s.motionBursts >= 1 ? 1 : 2;

  const riskText = dailySummaryTemplates.risk[
    s.abnormal === 0 ? 0 :
    s.abnormal <= 2 ? 1 : 2
  ].replace("{n}", s.abnormal);

  const topAction = Object.entries(s.actions)
    .sort((a,b)=>b[1]-a[1])[0]?.[0];

  const actionCN = {
    patrol:"å·¡è§†", sniff_food:"é—»é£Ÿç›†", play:"ç©è€", sleep:"ç¡è§‰",
    rest:"ä¼‘æ¯", sunbathe:"æ™’å¤ªé˜³", litter:"å¦‚å•", drink:"å–æ°´",
    chase:"è¿½é€/è·‘é…·", fight:"å†²çª", vomit:"å‘•å", still:"é™æ­¢"
  }[topAction] || "æ—¥å¸¸æ´»åŠ¨";

  const opener = rnd(dailySummaryTemplates.openers).replace("{pet}", petName);
  const energyLine = dailySummaryTemplates.energy[energyIdx];
  const ending = rnd(dailySummaryTemplates.endings);

  let extra = "";
  if(s.lastAbnormal==="vomit") extra = "ä»Šå¤©æœ‰è¿‡ä¸€æ¬¡ç–‘ä¼¼å‘•åï¼Œæˆ‘å»ºè®®è§‚å¯Ÿé£Ÿæ¬²å’Œç²¾ç¥ã€‚";
  if(s.lastAbnormal==="fight") extra = "ä»Šå¤©å‡ºç°è¿‡å†²çªä¿¡å·ï¼Œè‹¥æ˜¯ç£¨åˆæœŸå¯è€ƒè™‘å‡å°‘ç¢°é¢å‹åŠ›ã€‚";
  if(s.lastAbnormal==="still") extra = "ä»Šå¤©æœ‰è¿‡é•¿æ—¶é—´é™æ­¢æ®µï¼Œå¦‚æœæ™šäº›æ—¶å€™è¿˜ä¸æ´»è·ƒå†å…³æ³¨ã€‚";

  return [
    opener,
    `ä¸»è¦æ´»åŠ¨åŒºåŸŸï¼š${roomText}ã€‚`,
    `æœ€å¸¸è§çš„è¡Œä¸ºæ˜¯ã€Œ${actionCN}ã€ï¼Œç´¯è®¡ ${s.actions[topAction]||1} æ¬¡ã€‚`,
    `è¿åŠ¨/è¿½é€å³°å€¼ ${s.motionBursts} æ¬¡ï¼›å¦‚å• ${s.litter} æ¬¡ï¼›é¥®é£Ÿ/é¥®æ°´ç›¸å…³ ${s.drinkEat} æ¬¡ï¼›ä¼‘æ¯/ç¡çœ ç›¸å…³ ${s.restSleep} æ¬¡ã€‚`,
    energyLine,
    riskText,
    extra,
    ending
  ].filter(Boolean).join(" ");
}

function renderDailySummary(){
  const el = $("#dailySummary");
  if(!el) return;
  el.textContent = llmDailySummary(activePet);

  const st = dailyStats[activePet];
  const mins = Math.floor((Date.now()-st.startTs)/60000);
  $("#summaryTime").textContent = `å·²è·Ÿè¸ª ${mins} åˆ†é’Ÿ`;
}

// è‡ªåŠ¨èŠ‚æµï¼šåªæœ‰è¶…è¿‡ SUMMARY_REFRESH_MS æ‰åˆ·æ–°
function maybeRefreshDailySummary(force=false){
  const now = Date.now();
  if(force || now - lastSummaryTs >= SUMMARY_REFRESH_MS){
    renderDailySummary();
    lastSummaryTs = now;
  }
}

/* -----------------------------
   Init UI
----------------------------- */
function initPets(){
  const strip = $("#petStrip");
  strip.innerHTML = "";
  pets.forEach(p=>{
    const div = document.createElement("div");
    div.className = "pet-chip" + (p.id===activePet?" active":"");
    div.dataset.pet = p.id;
    div.innerHTML = `
      <div class="pet-avatar">${p.emoji}</div>
      <div class="pet-meta">
        <div class="pet-name">${p.name}</div>
        <div class="pet-state">${p.id===activePet?"è¿½è¸ªä¸­":"å¾…æœº"}</div>
      </div>`;
    div.onclick = ()=>setActivePet(p.id);
    strip.appendChild(div);
  });

  const profiles = $("#petProfiles");
  profiles.innerHTML = pets.map(p=>`
    <div class="row">
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="pet-avatar">${p.emoji}</div>
        <div>
          <div style="font-weight:900;">${p.name}</div>
          <div class="tagline">1 å² Â· çŸ®è„šç±³åŠªç‰¹ Â· å·²ç»è‚²</div>
        </div>
      </div>
      <div class="sub">ç¼–è¾‘</div>
    </div>
  `).join("");
}

function initTabs(){
  $$(".tab-btn").forEach(btn=>{
    btn.onclick=()=>{
      activeTab = btn.dataset.tab;
      $$(".tab-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===activeTab));
      showTab(activeTab);
    }
  });
}

function showTab(tab){
  $("#tab-watch").classList.toggle("hidden", tab!=="watch");
  $("#tab-location").classList.toggle("hidden", tab!=="location");
  $("#tab-feed").classList.toggle("hidden", tab!=="feed");
  $("#tab-me").classList.toggle("hidden", tab!=="me");
}

/* -----------------------------
   Live behaviors simulation
----------------------------- */
function setActivePet(petId){
  activePet = petId;
  behaviorIdx = 0;
  recentContext = [];
  dailyStats[petId] = initDailyStats();
  initPets();
  updateBehavior(true);
  renderFeed();
  renderAlerts();
  updateLocationFromBehavior();
  maybeRefreshDailySummary(true);
}

function setActiveCam(camKey){
  activeCam = camKey;
  $$(".cam-btn").forEach(b=>b.classList.toggle("active", b.dataset.cam===camKey));
  $$(".camPick").forEach(b=>b.classList.toggle("active", b.dataset.cam===camKey));
  $("#headerPill").textContent = cams[camKey].name + " Â· è¿½è¸ªä¸­";
  $("#camCoverage").textContent = "å½“å‰ï¼š" + cams[camKey].name + "ä¼˜å…ˆ";
  const v = $("#liveVideo");
  v.pause();
  v.querySelector("source").src = cams[camKey].video;
  v.load(); v.play();
}

function updateBehavior(force=false){
  const list = behaviors[activePet];
  if(!list || !list.length) return;
  const b = list[behaviorIdx % list.length];

  const chip = $("#behaviorChip");
  chip.classList.remove("ok","warn","danger");
  chip.classList.add(b.level);
  $("#behaviorText").textContent = b.text;

  const box = $("#trackBox");
  const left = 20 + (b.pos[0]/100)*60;
  const top  = 18 + (b.pos[1]/100)*50;
  box.style.left = left + "%";
  box.style.top  = top + "%";
  $("#trackLabel").textContent = "è¿½è¸ªï¼š" + pets.find(p=>p.id===activePet).name;

  $("#locPetName").textContent = pets.find(p=>p.id===activePet).name + " Â· ç°åœ¨åœ¨" + b.room;

  const n = llmNarrate(b);
  const narrEl = $("#aiNarration");
  if(narrEl) narrEl.textContent = n;

  recentContext.push({room:b.room, action:b.action});
  recentContext = recentContext.slice(-6);

  updateDailyStats(b);
  maybeRefreshDailySummary(false);

  if(b.abnormal && !force){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    const newAlert = {
      id:"a"+Math.random().toString(36).slice(2,7),
      pet:activePet, time:`${hh}:${mm}`,
      type:b.abnormal,
      title: b.abnormal==="vomit"?"ç–‘ä¼¼å‘•å":(b.abnormal==="fight"?"ç–‘ä¼¼æ‰“æ¶":"é•¿æ—¶é—´ä¸åŠ¨"),
      level: b.level==="danger"?"danger":"warn",
      desc: llmNarrate(b)
    };
    alerts.unshift(newAlert);
    alerts = alerts.slice(0,6);
    renderAlerts();
  }

  updateLocationFromBehavior();
  behaviorIdx++;
}

function tickBehaviors(){
  updateBehavior(false);
  setTimeout(tickBehaviors, BEHAVIOR_INTERVAL_MS);
}

/* -----------------------------
   Location simulation
----------------------------- */
const roomAnchors = {
  "å®¢å…":[30,35],
  "å§å®¤":[78,22],
  "é¤åŒº":[25,80],
  "çŒ«ç ‚åŒº":[78,78]
};

function updateLocationFromBehavior(){
  const b = behaviors[activePet][(behaviorIdx-1+behaviors[activePet].length)%behaviors[activePet].length];
  if(!b) return;
  movePetDot(b.pos[0], b.pos[1]);
}

function movePetDot(xPct, yPct){
  const fp = $("#floorplan");
  const dot = $("#petDot");
  const rect = fp.getBoundingClientRect();
  const x = rect.width * (xPct/100);
  const y = rect.height * (yPct/100);

  dot.style.left = x + "px";
  dot.style.top  = y + "px";

  trail.push([x,y]);
  trail = trail.slice(-8);
  renderTrail();
}

function renderTrail(){
  const layer = $("#trailLayer");
  layer.innerHTML = "";
  trail.forEach((p,i)=>{
    const d = document.createElement("div");
    d.className="trail";
    d.style.left = p[0]+"px";
    d.style.top  = p[1]+"px";
    d.style.opacity = (i+1)/trail.length * .7;
    d.style.transform = "translate(-50%,-50%) scale("+(0.6 + i*0.08)+")";
    layer.appendChild(d);
  });
}

function initTimeSlider(){
  const slider = $("#timeSlider");
  slider.oninput = ()=>{
    const val = Number(slider.value);
    $("#timeLabel").textContent = String(val).padStart(2,"0")+":00";
    const seed = val*7 + (activePet==="mino"?3:11);
    const rooms = ["å®¢å…","å§å®¤","é¤åŒº","çŒ«ç ‚åŒº"];
    const room = rooms[seed % rooms.length];
    const anchor = roomAnchors[room];
    const jitter = (n)=> n + (seed%5 - 2)*2;
    movePetDot(jitter(anchor[0]), jitter(anchor[1]));
    $("#locPetName").textContent = pets.find(p=>p.id===activePet).name + " Â· " + room;
  };
}

/* -----------------------------
   Feed rendering + filters
----------------------------- */
let activeFilter = "all";

function renderFeed(){
  const list = $("#feedList");
  const shown = feedItems.filter(it=>{
    if(activeFilter==="all") return it.pet===activePet;
    return it.pet===activePet && it.type===activeFilter;
  });

  list.innerHTML = shown.map(it=>{
    const petName = pets.find(p=>p.id===it.pet)?.name || "";
    const llmLine = `AIè§£è¯»ï¼š${petName}${it.desc}ï¼ˆdemoï¼‰`;
    return `
      <div class="feed-item">
        <div class="feed-ic">${it.icon}</div>
        <div class="feed-body">
          <div class="feed-title">${it.t} Â· ${it.title}</div>
          <div class="feed-meta">${llmLine}</div>
          ${it.level?`<div class="feed-meta" style="color:${it.level==="danger"?"var(--danger)":"var(--warn)"};font-weight:900;">${it.level==="danger"?"é«˜é£é™©":"éœ€å…³æ³¨"}</div>`:""}
          <div class="feed-actions">
            ${it.clip?`<div class="feed-btn" data-clip="${it.t}">æŸ¥çœ‹ç‰‡æ®µ</div>`:""}
            <div class="feed-btn ghost" data-jump="${it.t}">å®šä½è”åŠ¨</div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  $$("[data-clip]").forEach(b=>{
    b.onclick=()=>toast("æ‰“å¼€ "+b.dataset.clip+" è¯æ®å›æ”¾ï¼ˆdemoï¼‰");
  });
  $$("[data-jump]").forEach(b=>{
    b.onclick=()=>{
      activeTab="location";
      $$(".tab-btn").forEach(x=>x.classList.toggle("active", x.dataset.tab===activeTab));
      showTab("location");
      $("#timeSlider").value = Number(b.dataset.jump.split(":")[0]);
      $("#timeSlider").dispatchEvent(new Event("input"));
      toast("å·²è”åŠ¨åˆ°ä½ç½®é¡µ "+b.dataset.jump);
    }
  });
}

function initFeedFilters(){
  $$("[data-filter]").forEach(p=>{
    p.onclick=()=>{
      activeFilter = p.dataset.filter;
      $$("[data-filter]").forEach(x=>{
        x.style.background="#fff"; x.style.border="1px solid var(--line)"; x.style.color="#111";
      });
      p.style.background="#FFF4F0"; p.style.border="1px solid #FFD7C8";
      renderFeed();
    };
  });
}

/* -----------------------------
   Alerts rendering + modal
----------------------------- */
function renderAlerts(){
  const preview = $("#alertPreview");
  const list = $("#alertsList");
  const count = alerts.filter(a=>a.pet===activePet).length;
  $("#alertCount").textContent = count + " æ¡æ–°å‘Šè­¦";

  const top2 = alerts.filter(a=>a.pet===activePet).slice(0,2);
  preview.innerHTML = top2.map(a=>alertCardHTML(a,true)).join("");

  list.innerHTML = alerts.filter(a=>a.pet===activePet).map(a=>alertCardHTML(a,false)).join("");

  $$("[data-alert-clip]").forEach(b=>{
    b.onclick=()=>toast("æ’­æ”¾ "+b.dataset.alertClip+" å‘Šè­¦ç‰‡æ®µï¼ˆdemoï¼‰");
  });
  $$("[data-alert-false]").forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.alertFalse;
      alerts = alerts.filter(x=>x.id!==id);
      renderAlerts();
      toast("å·²æ ‡è®°è¯¯æŠ¥");
    }
  });
  $$("[data-alert-note]").forEach(b=>{
    b.onclick=()=>toast("å·²æ·»åŠ å¤‡æ³¨ï¼ˆdemoï¼‰");
  });
}

function alertCardHTML(a,compact){
  const petName = pets.find(p=>p.id===a.pet)?.name || "";
  const lvlClass = a.level==="danger"?"lvl-danger":(a.level==="warn"?"lvl-warn":"lvl-info");
  return `
    <div class="alert-card${compact?"":" shadowless"}">
      <div class="alert-level ${lvlClass}">${a.level==="danger"?"é«˜é£é™©":"éœ€å…³æ³¨"}</div>
      <div style="flex:1;">
        <div class="alert-title">${a.time} Â· ${petName} Â· ${a.title}</div>
        <div class="alert-desc">${a.desc}</div>
        <div class="alert-actions">
          <div class="small-btn" data-alert-clip="${a.time}">æŸ¥çœ‹ç‰‡æ®µ</div>
          ${compact?``:`
            <div class="small-btn ghost" data-alert-false="${a.id}">è¯¯æŠ¥</div>
            <div class="small-btn ghost" data-alert-note="${a.id}">å¤‡æ³¨</div>
          `}
        </div>
      </div>
    </div>
  `;
}

function initAlertsModal(){
  $("#openAlerts").onclick=()=>$("#alertsModal").classList.add("show");
  $("#closeAlerts").onclick=()=>$("#alertsModal").classList.remove("show");
  $("#alertsModal").onclick=(e)=>{
    if(e.target.id==="alertsModal") $("#alertsModal").classList.remove("show");
  };
}

/* -----------------------------
   Misc UI
----------------------------- */
function initCameraButtons(){
  $$(".cam-btn").forEach(b=>b.onclick=()=>setActiveCam(b.dataset.cam));
  $$(".camPick").forEach(b=>b.onclick=()=>setActiveCam(b.dataset.cam));
}

function initSwitches(){
  $$(".switch").forEach(sw=>{
    sw.onclick=()=>sw.classList.toggle("on");
  });
}

function updateClock(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  $("#liveTime").textContent = `ä»Šå¤© ${hh}:${mm}`;
}
setInterval(updateClock, 60000);

function toast(text){
  const t = document.createElement("div");
  t.textContent = text;
  t.style.position="fixed"; t.style.left="50%"; t.style.bottom="110px";
  t.style.transform="translateX(-50%)"; t.style.background="#111"; t.style.color="#fff";
  t.style.padding="10px 12px"; t.style.borderRadius="12px"; t.style.fontWeight="800";
  t.style.fontSize="13px"; t.style.zIndex=9999; t.style.boxShadow="var(--shadow)";
  document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity="0"; t.style.transition="opacity .25s";}, 1200);
  setTimeout(()=>t.remove(), 1500);
}

/* -----------------------------
   App start
----------------------------- */
initPets();
initTabs();
initCameraButtons();
initTimeSlider();
initFeedFilters();
initAlertsModal();
initSwitches();
renderFeed();
renderAlerts();
maybeRefreshDailySummary(true);
updateClock();
setActiveCam(activeCam);

$("#btnReplay").onclick=()=>toast("å›æ”¾æœ€è¿‘ 10 ç§’ï¼ˆdemoï¼‰");
$("#btnCall").onclick=()=>toast("å·²å‘å‡ºå‘¼å«ï¼š'å’ªå’ªè¿‡æ¥ï½'ï¼ˆdemoï¼‰");
$("#btnSnap").onclick=()=>toast("æˆªå›¾å·²ä¿å­˜åˆ°ç›¸å†Œï¼ˆdemoï¼‰");

const refreshBtn = $("#btnRefreshSummary");
if(refreshBtn) refreshBtn.onclick = ()=> {
  maybeRefreshDailySummary(true);
  toast("å°ç»“å·²åˆ·æ–°ï¼ˆdemoï¼‰");
};

const shareBtn = $("#btnShareSummary");
if(shareBtn) shareBtn.onclick = ()=>toast("å·²ç”Ÿæˆåˆ†äº«å›¾ï¼ˆdemoï¼‰");

tickBehaviors();
</script>
</body>
</html>
